<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>
    SSH反向连接及Autossh - ciandcd</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="http://www.ciandcd.com/theme/css/bootstrap.css" rel="stylesheet" type="text/css"/>
  <link href="http://www.ciandcd.com/theme/css/main.css" rel="stylesheet" type="text/css"/>
  <link href="http://www.ciandcd.com/theme/css/pygment.css" rel="stylesheet" type="text/css"/>
  <link href="http://fonts.googleapis.com/css?family=Chelsea+Market" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" type="text/css" href="http://www.ciandcd.com/theme/tipuesearch/tipuesearch.css" media="screen">
<link href="http://www.ciandcd.com/feeds/rss.xml" rel="alternate" type="application/atom+xml" title="ciandcd RSS" />


  <!--[if lt IE 9]>
    <script src="https://raw.github.com/aFarkas/html5shiv/master/dist/html5shiv.js"></script>
  <![endif]-->
</head>

<!--
bootstrap-itech - a Pelican theme using Bootstrap
-->
<body>

<!-- Header -->
<header>
<div class="container-fluid">
<h1 class="page-header"><a href="http://www.ciandcd.com/index.html">ciandcd </a>
<h4>软件持续集成和持续发布 QQ群：172758282，437085002</h4></h1>
</div>
</header>
<!-- /Header -->

<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.ciandcd.com/index.html"></a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

  <li><a href="http://www.ciandcd.com/index.html">首页</a></li>

  <li ><a href="http://www.ciandcd.com/category/ciandcd.html">ciandcd</a></li>
  <li ><a href="http://www.ciandcd.com/category/devops.html">devops</a></li>
  <li ><a href="http://www.ciandcd.com/category/scm.html">scm</a></li>
  <li class="active"><a href="http://www.ciandcd.com/category/zhong-wen.html">中文</a></li>

  
    <li ><a href="http://www.ciandcd.com/pages/guan-yu.html">关于</a></li>
    <li ><a href="http://www.ciandcd.com/pages/awesome.html">Awesome</a></li>


</ul>
      <form class="navbar-form navbar-left navbar-search" role="search" action="http://www.ciandcd.com/search.html onsubmit="return validateForm(this.elements['q'].value);">
        <div class="form-group search-query">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input">
        </div>
      </form>

      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://www.cnblogs.com/itech">itech</a></li>
        <li><a href="https://github.com/ciandcd">Github</a></li>
      </ul>

    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<!-- Body -->
<section id="body">
<div class="container-fluid">

<!-- Nav bar -->
<!-- /Nav bar -->

<!-- Main block -->
<div class="row">

<!-- Content -->
<div class="col-lg-9">
<article>

From:<a href="http://www.cnblogs.com/itech/p/4572275.html">http://www.cnblogs.com/itech/p/4572275.html</a><br><br><div><p>&#36716;&#33258;&#65306;&#160;http://www.cnblogs.com/eshizhan/archive/2012/07/16/2592902.html</p><p><strong>0.</strong>&#25509;&#35302;Linux&#24656;&#24597;&#23545;SSH&#20877;&#29087;&#24713;&#19981;&#36807;&#20102;&#65292;&#36824;&#26377;scp&#65292;sftp&#21508;&#31181;&#26041;&#20415;&#30340;&#21151;&#33021;&#65292;&#19968;&#33324;&#30340;&#20351;&#29992;&#37117;&#38656;&#35201;ip:port&#65288;&#22914;&#26524;&#19981;&#26159;&#40664;&#35748;22&#30340;&#35805;&#65289;&#65292;&#20294;&#26377;&#20123;&#24773;&#20917;&#27604;&#36739;&#29305;&#27530;&#65292;&#23601;&#26159;&#24819;&#36830;&#25509;&#19968;&#21488;&#20869;&#32593;&#20027;&#26426;&#65288;&#27604;&#22914;&#20844;&#21496;&#20869;&#32593;&#65292;&#24403;&#28982;&#20320;&#32943;&#23450;&#20570;&#19981;&#20102;Port Forwarding&#65292;&#38500;&#38750;&#20320;&#24819;&#22312;&#20844;&#21496;&#38450;&#28779;&#22681;&#19978;&#25286;&#20010;&#27934;&#65289;&#12290;&#31245;&#25026;&#19968;&#28857;&#32593;&#32476;&#30340;&#31461;&#38795;&#20250;&#26126;&#30333;&#65292;Internet&#19978;&#21435;&#20027;&#21160;&#36830;&#25509;&#19968;&#21488;&#20869;&#32593;&#26159;&#19981;&#21487;&#33021;&#30340;&#65292;&#19968;&#33324;&#30340;&#35299;&#20915;&#26041;&#26696;&#20998;&#20004;&#31181;&#65292;&#19968;&#31181;&#26159;&#31471;&#21475;&#26144;&#23556;&#65288;Port Forwarding&#65289;&#65292;&#23558;&#20869;&#32593;&#20027;&#26426;&#30340;&#26576;&#20010;&#31471;&#21475;Open&#20986;&#38450;&#28779;&#22681;&#65292;&#30456;&#24403;&#20110;&#20004;&#20010;&#22806;&#32593;&#20027;&#26426;&#36890;&#20449;&#65307;&#21478;&#19968;&#31181;&#26159;&#20869;&#32593;&#20027;&#26426;&#20027;&#21160;&#36830;&#25509;&#21040;&#22806;&#32593;&#20027;&#26426;&#65292;&#21448;&#34987;&#31216;&#20316;&#21453;&#21521;&#36830;&#25509;&#65288;Reverse Connection&#65289;&#65292;&#36825;&#26679;NAT&#36335;&#30001;/&#38450;&#28779;&#22681;&#23601;&#20250;&#22312;&#20869;&#32593;&#20027;&#26426;&#21644;&#22806;&#32593;&#20027;&#26426;&#20043;&#38388;&#24314;&#31435;&#26144;&#23556;&#65292;&#33258;&#28982;&#21487;&#20197;&#30456;&#20114;&#36890;&#20449;&#20102;&#12290;&#20294;&#26159;&#65292;&#36825;&#31181;&#26144;&#23556;&#26159;NAT&#36335;&#30001;&#33258;&#21160;&#32500;&#25345;&#30340;&#65292;&#19981;&#20250;&#25345;&#32493;&#19979;&#21435;&#65292;&#22914;&#26524;&#36830;&#25509;&#26029;&#24320;&#25110;&#32773;&#32593;&#32476;&#19981;&#31283;&#23450;&#37117;&#20250;&#23548;&#33268;&#36890;&#20449;&#22833;&#36133;&#65292;&#36825;&#26102;&#20869;&#32593;&#20027;&#26426;&#38656;&#35201;&#20877;&#27425;&#20027;&#21160;&#36830;&#25509;&#21040;&#22806;&#32593;&#20027;&#26426;&#65292;&#24314;&#31435;&#36830;&#25509;&#12290;</p>&#13;
<p>&#160;</p>&#13;
<h2>1.&#29702;&#35770;&#30340;&#20171;&#32461;&#23436;&#20102;&#65292;&#19979;&#38754;&#23454;&#38469;&#25805;&#20316;&#65306;</h2>&#13;
<p>A&#35201;&#25511;&#21046;B</p>&#13;
<p>A&#20027;&#26426;&#65306;&#22806;&#32593;&#65292;ip&#65306;123.123.123.123&#65292;sshd&#31471;&#21475;&#65306;2221</p>&#13;
<p>B&#20027;&#26426;&#65306;&#20869;&#32593;&#65292;sshd&#31471;&#21475;&#65306;2223</p>&#13;
<p>&#26080;&#35770;&#26159;&#22806;&#32593;&#20027;&#26426;A&#65292;&#36824;&#26159;&#20869;&#32593;&#20027;&#26426;B&#37117;&#38656;&#35201;&#36305;ssh daemon</p>&#13;
<p>&#160;</p>&#13;
<h4>1.1.&#39318;&#20808;&#22312;B&#19978;&#25191;&#34892;</h4>&#13;
<pre>$ ssh -NfR 1234:localhost:2223 user1@123.123.123.123 -p2221</pre>&#13;
<p>&#36825;&#21477;&#35805;&#30340;&#24847;&#24605;&#26159;&#23558;A&#20027;&#26426;&#30340;1234&#31471;&#21475;&#21644;B&#20027;&#26426;&#30340;2223&#31471;&#21475;&#32465;&#23450;&#65292;&#30456;&#24403;&#20110;&#36828;&#31243;&#31471;&#21475;&#26144;&#23556;&#65288;Remote Port Forwarding&#65289;&#12290;</p>&#13;
<p>&#36825;&#37324;&#27599;&#27425;&#38656;&#35201;&#36755;&#20837;A&#20027;&#26426;user1&#30340;&#30331;&#38470;&#23494;&#30721;&#65292;&#21518;&#38754;&#20250;&#35762;&#21040;&#35299;&#20915;&#21150;&#27861;&#12290;</p>&#13;
<p>&#160;</p>&#13;
<h4>1.2.&#36825;&#26102;&#22312;A&#20027;&#26426;&#19978;sshd&#20250;listen&#26412;&#22320;1234&#31471;&#21475;</h4>&#13;
<pre>$ ss -ant<br>&#13;
State      Recv-Q Send-Q        Local Address:Port          Peer Address:Port&#13;
LISTEN     0      128               127.0.0.1:1234                     *:*</pre>&#13;
<h4>1.3.&#20687;&#24179;&#26102;&#19968;&#26679;&#36830;&#25509;&#21040;A&#20027;&#26426;&#30340;1234&#31471;&#21475;&#23601;&#21487;&#20197;&#25511;&#21046;&#20869;&#32593;B&#20027;&#26426;&#20102;</h4>&#13;
<pre>$ ssh localhost -p1234</pre>&#13;
<p>&#160;</p>&#13;
<h3>2.&#19968;&#24320;&#22987;&#25552;&#21040;&#65292;&#36825;&#31181;&#21453;&#21521;&#36830;&#25509;&#65288;Reverse Connection&#65289;&#19981;&#31283;&#23450;&#65292;&#21487;&#33021;&#38543;&#26102;&#26029;&#24320;&#65292;&#38656;&#35201;&#20869;&#32593;&#20027;&#26426;B&#20877;&#27425;&#21521;&#22806;&#32593;A&#21457;&#36215;&#36830;&#25509;&#65292;&#36825;&#26102;&#38656;&#35201;&#20010;&#8220;&#26379;&#21451;&#8221;&#24110;&#20320;&#22312;&#20869;&#32593;B&#20027;&#26426;&#25191;&#34892;&#36825;&#26465;&#21629;&#20196;&#12290;&#23427;&#23601;&#26159;Autossh&#12290;</h3>&#13;
<p>&#22312;&#27492;&#20043;&#21069;&#36824;&#35201;&#35299;&#20915;&#20043;&#21069;&#30340;&#19968;&#20010;&#38382;&#39064;&#65292;&#37027;&#23601;&#26159;&#27599;&#27425;&#20869;&#32593;&#20027;&#26426;B&#36830;&#25509;&#22806;&#32593;&#20027;&#26426;A&#26102;&#37117;&#38656;&#35201;&#36755;&#20837;&#23494;&#30721;&#65292;&#36825;&#20010;&#38382;&#39064;ssh&#26412;&#36523;&#26159;&#25552;&#20379;&#21478;&#22806;&#19968;&#31181;&#39564;&#35777;&#26041;&#24335;&#8212;&#8212;&#36890;&#36807;&#23494;&#38053;&#39564;&#35777;&#29992;&#25143;&#36523;&#20221;&#65292;&#23454;&#29616;&#33258;&#21160;&#30331;&#24405;&#12290;</p>&#13;
<p>&#160;</p>&#13;
<h4>2.1.&#22312;&#20869;&#32593;B&#20027;&#26426;&#19978;&#29983;&#20135;&#20844;&#38053;&#21644;&#31169;&#38053;</h4>&#13;
<pre>$ ssh-keygen&#13;
...(&#19968;&#30452;&#25353;Enter&#65292;&#26368;&#21518;&#22312;~/.ssh/&#19979;&#29983;&#25104;&#23494;&#38053;)&#13;
$ ls ~/.ssh/&#13;
id_rsa id_rsa.pub known_hosts</pre>&#13;
<p>&#160;</p>&#13;
<h4>2.2.&#22797;&#21046;B&#20027;&#26426;&#19978;&#29983;&#25104;&#30340;id_rsa.pub&#20844;&#38053;&#21040;&#22806;&#32593;A&#20027;&#26426;&#19978;&#65292;&#24182;&#23558;&#20869;&#23481;&#21152;&#20837;&#21040;~/.ssh/authorized_keys&#20013;</h4>&#13;
<pre>$ cat id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</pre>&#13;
<p>&#35797;&#19979;&#65292;&#20869;&#32593;B&#20027;&#26426;&#36830;&#25509;&#22806;&#32593;A&#20027;&#26426;&#65292;&#23601;&#19981;&#20877;&#36755;&#20837;&#23494;&#30721;&#39564;&#35777;&#20102;</p>&#13;
<p>&#34917;&#20805;&#65306;&#20170;&#22825;&#20102;&#35299;&#21040;ssh-copy-id&#36825;&#20010;&#21629;&#20196;&#65292;&#19978;&#38754;&#36825;&#20010;&#25805;&#20316;&#23601;&#21464;&#30340;&#31616;&#21333;&#20102;</p>&#13;
<pre>$ ssh-copy-id user1@123.123.123.123</pre>&#13;
<p>&#160;</p>&#13;
<h4>2.3.&#20877;&#26469;&#30475;&#30475;Autossh&#30340;&#29992;&#27861;</h4>&#13;
<pre>$ autossh -M 5678 -NR 1234:localhost:2223 user1@123.123.123.123 -p2221</pre>&#13;
<p>&#27604;&#20043;&#21069;&#30340;&#21629;&#20196;&#28155;&#21152;&#30340;&#19968;&#20010;-M 5678&#21442;&#25968;&#65292;&#36127;&#36131;&#36890;&#36807;5678&#31471;&#21475;&#30417;&#35270;&#36830;&#25509;&#29366;&#24577;&#65292;&#36830;&#25509;&#26377;&#38382;&#39064;&#26102;&#23601;&#20250;&#33258;&#21160;&#37325;&#36830;&#65292;&#21435;&#25481;&#20102;&#19968;&#20010;-f&#21442;&#25968;&#65292;&#22240;&#20026;autossh&#26412;&#36523;&#23601;&#20250;&#22312;background&#36816;&#34892;&#12290;</p>&#13;
<p>&#160;</p>&#13;
<h2>3.&#32456;&#26497;&#26041;&#26696;&#65306;&#24403;&#37325;&#21551;&#20869;&#32593;B&#20027;&#26426;&#65292;&#35841;&#26469;&#33258;&#21160;Autossh&#21602;&#65292;&#21152;&#20837;daemon&#21543;</h2>&#13;
<p>&#20197;daemon&#26041;&#24335;&#25191;&#34892;&#65292;&#30456;&#24403;&#20110;root&#21435;&#25191;&#34892;autossh, ssh&#65292;&#36825;&#26102;&#21018;&#25165;&#26222;&#36890;&#29992;&#25143;&#30446;&#24405;&#19979;&#30340;.ssh/authorized_keys&#25991;&#20214;&#20250;&#19981;&#36215;&#25928;&#12290;&#26377;&#20004;&#31181;&#21150;&#27861;&#35299;&#20915;&#65292;&#19968;&#31181;&#26159;&#29992;autossh&#30340;&#21442;&#25968;&#25351;&#23450;.ssh&#36335;&#24452;&#65307;&#21478;&#22806;&#19968;&#31181;&#26159;&#20197;&#26222;&#36890;&#29992;&#25143;&#36523;&#20221;&#25191;&#34892;daemon&#65292;&#19979;&#38754;&#26159;&#31532;&#20108;&#31181;&#26041;&#24335;&#12290;</p>&#13;
<pre>/bin/su -c '/usr/bin/autossh -M 5678 -NR 1234:localhost:2223 user1@123.123.123.123 -p2221' - user1</pre>&#13;
<p>autossh&#36824;&#26377;&#24456;&#22810;&#21442;&#25968;&#65292;&#29992;&#26469;&#35774;&#32622;&#37325;&#36830;&#38388;&#38548;&#31561;&#31561;&#12290;</p>&#13;
<p>&#23558;&#19978;&#38754;&#21629;&#20196;&#25918;&#20837;&#19979;&#38754;&#21508;&#21551;&#21160;&#26041;&#24335;&#20013;&#65292;&#26681;&#25454;&#33258;&#24049;&#31995;&#32479;&#33258;&#24049;&#37197;&#32622;&#65306;</p>&#13;
<p>SysV&#65306;/etc/inid.d/autossh</p>&#13;
<p>Upstart: /etc/init/autossh.conf</p>&#13;
<p>systemd: /usr/lib/systemd/system/autossh.service</p>&#13;
<p>&#160;</p>&#13;
<p>&#160;</p>&#13;
<h4>P.S.</h4>&#13;
<p>1.&#23478;&#37324;&#26159;ADSL&#30340;&#35805;&#65292;&#29992;DDNS&#65292;&#35299;&#20915;ip&#38382;&#39064;</p>&#13;
<p>2.&#22806;&#32593;&#26377;&#36335;&#30001;&#30340;&#21487;&#35774;&#19979;&#31471;&#21475;&#26144;&#23556;</p>&#13;
<p>3.&#34429;&#28982;&#26377;&#23494;&#38053;&#21644;&#23494;&#30721;&#20445;&#25252;&#65292;&#20294;&#36824;&#35831;&#23567;&#24515;&#20351;&#29992;</p>&#13;
</div>

<p class="info">
<h4>
Posted Sat 27 June 2015
 by <a class="url fn" href="http://www.ciandcd.com/author/itech001.html">itech001</a>
in <a href="http://www.ciandcd.com/category/zhong-wen.html">中文</a>
</h4></p>

</article>
</div>
<!-- /Content -->

<!-- Side bar -->
<nav class="col-lg-3">

<h2>分类</h2>
<ul class="nav nav-pills nav-stacked">
  <li ><a href="http://www.ciandcd.com/category/ciandcd.html">ciandcd</a></li>
  <li ><a href="http://www.ciandcd.com/category/devops.html">devops</a></li>
  <li ><a href="http://www.ciandcd.com/category/scm.html">scm</a></li>
  <li class="active"><a href="http://www.ciandcd.com/category/zhong-wen.html">中文</a></li>
</ul>

<ul class="tagcloud">
</ul>

<h2>链接</h2>
<ul class="nav nav-pills nav-stacked">
  <li><a href="http://www.cnblogs.com/itech/">itech</a></li>
</ul>

<h2>联系</h2>
<ul class="nav nav-pills nav-stacked">
  <li><a href="http://www.ciandcd.com/feeds/rss.xml" type="application/rss+xml" rel="alternate">Site Feed</a></li>
  <li><a href="https://github.com/ciandcd">Github</a></li>
</ul>

</nav>
<!-- /Side bar -->

</div>
<!-- /Main block -->

<!-- Footer -->
<div class="row"><div class="col-lg-12">
<footer><small>
Built using <a href="http://pelican.notmyidea.org/">Pelican</a> and
<a href="http://twitter.github.com/bootstrap">Bootstrap</a>.
</small></footer>
</div></div>
<!-- /Footer -->

</div></section>
<!-- /Body -->

<script src="http://www.ciandcd.com/theme/js/jquery.js"></script>
<script src="http://www.ciandcd.com/theme/js/bootstrap.js"></script>


</body>
</html>