<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>
    Adding NTLM SSO to Nancyfx - ciandcd</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="http://www.ciandcd.com/theme/css/bootstrap.css" rel="stylesheet" type="text/css"/>
  <link href="http://www.ciandcd.com/theme/css/main.css" rel="stylesheet" type="text/css"/>
  <link href="http://www.ciandcd.com/theme/css/pygment.css" rel="stylesheet" type="text/css"/>
  <link href="http://fonts.googleapis.com/css?family=Chelsea+Market" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" type="text/css" href="http://www.ciandcd.com/theme/tipuesearch/tipuesearch.css" media="screen">
<link href="http://www.ciandcd.com/feeds/rss.xml" rel="alternate" type="application/atom+xml" title="ciandcd RSS" />


  <!--[if lt IE 9]>
    <script src="https://raw.github.com/aFarkas/html5shiv/master/dist/html5shiv.js"></script>
  <![endif]-->
</head>

<!--
bootstrap-itech - a Pelican theme using Bootstrap
-->
<body>

<!-- Header -->
<header>
<div class="container-fluid">
<h1 class="page-header"><a href="http://www.ciandcd.com/index.html">ciandcd </a>
<h4>软件持续集成和持续发布 QQ群：172758282，437085002</h4></h1>
</div>
</header>
<!-- /Header -->

<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.ciandcd.com/index.html"></a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

  <li><a href="http://www.ciandcd.com/index.html">首页</a></li>

  <li class="active"><a href="http://www.ciandcd.com/category/ciandcd.html">ciandcd</a></li>
  <li ><a href="http://www.ciandcd.com/category/devops.html">devops</a></li>
  <li ><a href="http://www.ciandcd.com/category/scm.html">scm</a></li>
  <li ><a href="http://www.ciandcd.com/category/zhong-wen.html">中文</a></li>

  
    <li ><a href="http://www.ciandcd.com/pages/guan-yu.html">关于</a></li>
    <li ><a href="http://www.ciandcd.com/pages/awesome.html">Awesome</a></li>


</ul>
      <form class="navbar-form navbar-left navbar-search" role="search" action="http://www.ciandcd.com/search.html onsubmit="return validateForm(this.elements['q'].value);">
        <div class="form-group search-query">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input">
        </div>
      </form>

      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://www.cnblogs.com/itech">itech</a></li>
        <li><a href="https://github.com/ciandcd">Github</a></li>
      </ul>

    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<!-- Body -->
<section id="body">
<div class="container-fluid">

<!-- Nav bar -->
<!-- /Nav bar -->

<!-- Main block -->
<div class="row">

<!-- Content -->
<div class="col-lg-9">
<article>

From:<a href="https://www.finalbuilder.com/resources/blogs/postid/730/adding-ntlm-sso-to-nancyfx">https://www.finalbuilder.com/resources/blogs/postid/730/adding-ntlm-sso-to-nancyfx</a><br><br><div><a></a><br>
<br>
<span><a></a><span><a href="https://github.com/NancyFx/Nancy" target="_blank" title="Nancyfx on Github.">Nancyfx</a> is a Lightweight, low-ceremony, framework for building HTTP based services on .Net and Mono. It's open source and available on github.</span></span><p>Nancy supports Forms Authentication, Basic Authentication and Stateless Authentication "out of the box", and it's simple to configure. In my application, I wanted to be able to handle mixed Forms and NTLM Authentication, which is something nancyfx &#160;doesn't support. We have done this before with asp.net on IIS, and it was not a simple task, involving a child site with windows authentication enabled while the main site had forms (IIS doesn't allow both at the same time) and all sorts of redirection. It was painful to develop, and it's painful to install and maintain.&#160;<br>
<br>
Fortunately with Nancy and <a href="http://owin.org/" target="_blank" title="Owin Website">Owin</a>, it's a lot simpler. Using Microsoft's implementation of the Owin spec, and Nancy's Owin support, it's actually quite easy, without the need for child websites and redirection etc.&#160;</p>
<p>I'm not going to explain how to use Nancy or Owin here, just the part needed to hook up NTLM support. In my application, NTLM authentication is invoked by a button on the login page ("Login using my windows account") which causes a specific login url to be hit. We're using Owin for hosting rather than IIS and Owin enables us to get access to the HttpListener, so we can control the authentication scheme for each url. We do this by adding an AuthenticationSchemeSelectorDelegate.</p>
<pre class="brush:c#; toolbar:true;">internal class Startup
{
    public void Configuration(IAppBuilder app)
    {
        var listener = (HttpListener)app.Properties["System.Net.HttpListener"];
       //add a delegate to select the auth scheme based on the url 
        listener.AuthenticationSchemeSelectorDelegate = request =&gt;
        {
            //the caller requests we try windows auth by hitting a specific url
            return request.RawUrl.Contains("loginwindows") ? AuthenticationSchemes.IntegratedWindowsAuthentication : AuthenticationSchemes.Anonymous;
        }
        app.UseNancy();
    }
}
</pre>
<br>
What this achieves is to invoke the NTLM negotiation if the "loginwindows" url is hit on our nancy application. If the negotiation is successful (ie the browser supports NTLM and is able to identify the user), &#160;then the Owin environment will have the details of the user, and this is how we get those details out of Owin (in our bootstrapper class).<br>
<br>
<pre class="brush:c#; toolbar:true;">protected override void ApplicationStartup(TinyIoCContainer container, IPipelines pipelines)
{
  pipelines.BeforeRequest.AddItemToStartOfPipeline((ctx) =&gt;
  {
      if (ctx.Request.Path.Contains("loginwindows"))
      {
          var env = ((IDictionary&lt;string,&gt;)ctx.Items[Nancy.Owin.NancyOwinHost.RequestEnvironmentKey]);
          var user = (IPrincipal)env["server.User"];
          if (user != null &amp;&amp; user.Identity.IsAuthenticated)
          {
              //remove the cookie if someone tried sending one in a request!
              if (ctx.Request.Cookies.ContainsKey("IntegratedWindowsAuthentication"))
                  ctx.Request.Cookies.Remove("IntegratedWindowsAuthentication");
              //Add the user as a cooking on the request object, so that Nancy can see it.
              ctx.Request.Cookies.Add("IntegratedWindowsAuthentication", user.Identity.Name);
          }
      }
      return null;//ensures normal processing continues. 
  });
}</pre>
<br>
Note we are adding the user in a cookie on the nancy Request object, which might seem a strange thing to do, but it was the only way I could find to add something to the request that can be accessed inside a nancy module, because everything else on the request object is read only. We don't send this cookie back to the user. So with that done, all that remains is the use that user in our login module<br>
<br>
<pre class="brush:c#; toolbar:true;"> Post["/loginwindows"] = parameters =&gt; 
    {
        string domainUser = "";
        if (this.Request.Cookies.TryGetValue("IntegratedWindowsAuthentication",out domainUser))
        {
            //Now we can check if the user is allowed access to the application and if so, add 
            //our forms auth cookie to the response.             
            ...
        }
    }
</pre>
<br>
Of course, this will probably only work on Windows, not sure what the current status is for System.Net.HttpListener is on Mono. This code was tested with Nancyfx 1.2 from nuget.&#160;<br>&#13;
                        <br>&#13;
                        <br>&#13;
                         &#13;
                    <p>What this achieves is to invoke the NTLM negotiation if the "loginwindows" url is hit on our nancy application. If the negotiation is successful (ie the browser supports NTLM and is able to identify the user), then the Owin environment will have the details of the user, and this is how we get those details out of Owin (in our bootstrapper class).Note we are adding the user in a cookie on the nancy Request object, which might seem a strange thing to do, but it was the only way I could find to add something to the request that can be accessed inside a nancy module, because everything else on the request object is read only. We don't send this cookie back to the user. So with that done, all that remains is the use that user in our login moduleOf course, this will probably only work on Windows, not sure what the current status is for System.Net.HttpListener is on Mono. This code was tested with Nancyfx 1.2 from nuget.</p></div>

<p class="info">
<h4>
Posted Sat 27 June 2015
 by <a class="url fn" href="http://www.ciandcd.com/author/itech001.html">itech001</a>
in <a href="http://www.ciandcd.com/category/ciandcd.html">ciandcd</a>
</h4></p>

</article>
</div>
<!-- /Content -->

<!-- Side bar -->
<nav class="col-lg-3">

<h2>分类</h2>
<ul class="nav nav-pills nav-stacked">
  <li class="active"><a href="http://www.ciandcd.com/category/ciandcd.html">ciandcd</a></li>
  <li ><a href="http://www.ciandcd.com/category/devops.html">devops</a></li>
  <li ><a href="http://www.ciandcd.com/category/scm.html">scm</a></li>
  <li ><a href="http://www.ciandcd.com/category/zhong-wen.html">中文</a></li>
</ul>

<ul class="tagcloud">
</ul>

<h2>链接</h2>
<ul class="nav nav-pills nav-stacked">
  <li><a href="http://www.cnblogs.com/itech/">itech</a></li>
</ul>

<h2>联系</h2>
<ul class="nav nav-pills nav-stacked">
  <li><a href="http://www.ciandcd.com/feeds/rss.xml" type="application/rss+xml" rel="alternate">Site Feed</a></li>
  <li><a href="https://github.com/ciandcd">Github</a></li>
</ul>

</nav>
<!-- /Side bar -->

</div>
<!-- /Main block -->

<!-- Footer -->
<div class="row"><div class="col-lg-12">
<footer><small>
Built using <a href="http://pelican.notmyidea.org/">Pelican</a> and
<a href="http://twitter.github.com/bootstrap">Bootstrap</a>.
</small></footer>
</div></div>
<!-- /Footer -->

</div></section>
<!-- /Body -->

<script src="http://www.ciandcd.com/theme/js/jquery.js"></script>
<script src="http://www.ciandcd.com/theme/js/bootstrap.js"></script>


</body>
</html>